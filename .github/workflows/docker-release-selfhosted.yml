name: Docker Recreate 

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: inveoninfra.azurecr.io

jobs:
  deploy:
    runs-on: sprint-dashboard
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
      - name: Log in to Azure Container Registry
        run: |
          echo "${{ secrets.AZURE_ACR_PASSWORD }}" | sudo docker login ${{ env.REGISTRY }} -u Oguzhan --password-stdin
      
      - name: Pull latest image
        run: |
          cd /home/inveon/sprint-dashboard
          sudo docker compose pull sprint-dashboard
      
      - name: Deploy with docker compose
        run: |
          cd /home/inveon/sprint-dashboard
          sudo docker compose up -d --force-recreate sprint-dashboard
      
      - name: Clean up old images
        run: sudo docker image prune -f
      
      - name: Check deployment status
        run: |
          cd /home/inveon/sprint-dashboard
          sudo docker compose ps sprint-dashboard
          sudo docker compose logs --tail=50 sprint-dashboard